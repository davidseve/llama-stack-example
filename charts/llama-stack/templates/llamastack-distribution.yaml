apiVersion: llamastack.io/v1alpha1
kind: LlamaStackDistribution
metadata:
  annotations:
    openshift.io/display-name: {{ .Values.global.name }}
  name: {{ .Values.global.name }}
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "llama-stack.labels" . | nindent 4 }}
spec:
  replicas: {{ .Values.llamastack.replicas }}
  server:
    containerSpec:
      env:
        # ==================== SECRETS (sensitive values from K8s Secret) ====================
        # vLLM API Tokens (dynamically generated from providers.vllm)
        {{- range $name, $vllm := .Values.providers.vllm }}
        {{- $tokenKey := $vllm.apiTokenSecret | default "VLLM_API_TOKEN" }}
        {{- $tokenValue := index $.Values.secret.data $tokenKey }}
        {{- if $tokenValue }}
        - name: {{ $tokenKey }}
          valueFrom:
            secretKeyRef:
              key: {{ $tokenKey }}
              name: {{ $.Values.global.name }}-secret
        {{- end }}
        {{- end }}
        # vLLM Embedding API Tokens (dynamically generated from providers.vllmEmbedding)
        {{- range $name, $embed := .Values.providers.vllmEmbedding }}
        {{- $tokenKey := $embed.apiTokenSecret | default "VLLM_API_TOKEN" }}
        {{- $tokenValue := index $.Values.secret.data $tokenKey }}
        {{- if $tokenValue }}
        - name: {{ $tokenKey }}
          valueFrom:
            secretKeyRef:
              key: {{ $tokenKey }}
              name: {{ $.Values.global.name }}-secret
        {{- end }}
        {{- end }}
        # AWS/Bedrock credentials
        {{- if .Values.secret.data.AWS_ACCESS_KEY_ID }}
        - name: AWS_ACCESS_KEY_ID
          valueFrom:
            secretKeyRef:
              key: AWS_ACCESS_KEY_ID
              name: {{ .Values.global.name }}-secret
        {{- end }}
        {{- if .Values.secret.data.AWS_SECRET_ACCESS_KEY }}
        - name: AWS_SECRET_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              key: AWS_SECRET_ACCESS_KEY
              name: {{ .Values.global.name }}-secret
        {{- end }}
        {{- if .Values.secret.data.AWS_SESSION_TOKEN }}
        - name: AWS_SESSION_TOKEN
          valueFrom:
            secretKeyRef:
              key: AWS_SESSION_TOKEN
              name: {{ .Values.global.name }}-secret
        {{- end }}
        # WatsonX API Key
        {{- if .Values.secret.data.WATSONX_API_KEY }}
        - name: WATSONX_API_KEY
          valueFrom:
            secretKeyRef:
              key: WATSONX_API_KEY
              name: {{ .Values.global.name }}-secret
        {{- end }}
        # Azure API Key
        {{- if .Values.secret.data.AZURE_API_KEY }}
        - name: AZURE_API_KEY
          valueFrom:
            secretKeyRef:
              key: AZURE_API_KEY
              name: {{ .Values.global.name }}-secret
        {{- end }}
        # OpenAI API Key
        {{- if .Values.secret.data.OPENAI_API_KEY }}
        - name: OPENAI_API_KEY
          valueFrom:
            secretKeyRef:
              key: OPENAI_API_KEY
              name: {{ .Values.global.name }}-secret
        {{- end }}
        # Milvus Token
        {{- if .Values.secret.data.MILVUS_TOKEN }}
        - name: MILVUS_TOKEN
          valueFrom:
            secretKeyRef:
              key: MILVUS_TOKEN
              name: {{ .Values.global.name }}-secret
        {{- end }}
        # FAISS KVStore Password (sensitive)
        {{- if .Values.secret.data.FAISS_KVSTORE_PASSWORD }}
        - name: FAISS_KVSTORE_PASSWORD
          valueFrom:
            secretKeyRef:
              key: FAISS_KVSTORE_PASSWORD
              name: {{ .Values.global.name }}-secret
        {{- end }}
        # PostgreSQL Credentials (sensitive only - host/port are in run.yaml config)
        {{- if .Values.providers.postgres.enabled }}
        - name: POSTGRES_DB
          valueFrom:
            secretKeyRef:
              name: {{ .Values.providers.postgres.secretName | default "postgres-secret" }}
              key: POSTGRES_DB
        - name: POSTGRES_USER
          valueFrom:
            secretKeyRef:
              name: {{ .Values.providers.postgres.secretName | default "postgres-secret" }}
              key: POSTGRES_USER
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: {{ .Values.providers.postgres.secretName | default "postgres-secret" }}
              key: POSTGRES_PASSWORD
        {{- end }}
        # Brave Search API Key
        {{- if .Values.secret.data.BRAVE_SEARCH_API_KEY }}
        - name: BRAVE_SEARCH_API_KEY
          valueFrom:
            secretKeyRef:
              key: BRAVE_SEARCH_API_KEY
              name: {{ .Values.global.name }}-secret
        {{- end }}
        # Tavily Search API Key
        {{- if .Values.secret.data.TAVILY_SEARCH_API_KEY }}
        - name: TAVILY_SEARCH_API_KEY
          valueFrom:
            secretKeyRef:
              key: TAVILY_SEARCH_API_KEY
              name: {{ .Values.global.name }}-secret
        {{- end }}
        # Kubeflow Pipelines Token (required for RAGAS remote mode)
        {{- if and .Values.providers.kubeflow.enabled .Values.secret.data.KUBEFLOW_PIPELINES_TOKEN }}
        - name: KUBEFLOW_PIPELINES_TOKEN
          valueFrom:
            secretKeyRef:
              key: KUBEFLOW_PIPELINES_TOKEN
              name: {{ .Values.global.name }}-secret
        {{- end }}
      name: {{ .Values.server.containerSpec.name }}
      port: {{ .Values.server.containerSpec.port }}
      resources:
        limits:
          cpu: {{ .Values.server.containerSpec.resources.limits.cpu | quote }}
          memory: {{ .Values.server.containerSpec.resources.limits.memory | quote }}
        requests:
          cpu: {{ .Values.server.containerSpec.resources.requests.cpu | quote }}
          memory: {{ .Values.server.containerSpec.resources.requests.memory | quote }}
    distribution:
      {{- $distImage := "" }}
      {{- if hasKey .Values.server "distribution" }}
        {{- $distImage = .Values.server.distribution.image | default "" }}
      {{- end }}
      {{- if $distImage }}
      image: {{ $distImage }}
      {{- else }}
      name: rh-dev
      {{- end }}
   {{- if .Values.config.enable }}
    userConfig:
      configMapName: {{ .Values.global.name }}-config
   {{- end }}
    storage:
      size: {{ .Values.server.storage.size | quote }}
{{- if .Values.route.enable }}
---
kind: Route
apiVersion: route.openshift.io/v1
metadata:
  name: {{ .Values.global.name }}
  namespace: {{ .Values.global.namespace }}
  annotations:
    haproxy.router.openshift.io/timeout: {{ .Values.route.timeout | default "300s" | quote }}
    haproxy.router.openshift.io/timeout-tunnel: {{ .Values.route.timeout | default "300s" | quote }}
    {{- with .Values.route.annotations }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
spec:
  to:
    kind: Service
    name: {{ .Values.global.name }}-service
    weight: 100
  port:
    targetPort: http
  tls:
    termination: edge
    insecureEdgeTerminationPolicy: None
  wildcardPolicy: None
{{- end }}
